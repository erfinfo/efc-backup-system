# üêß Configuration Serveur Linux - EFC Backup System

Guide complet pour configurer votre serveur Linux de destination des backups.

## üìã Pr√©requis Serveur

### Sp√©cifications Minimales
- **OS** : Ubuntu 20.04+, Debian 11+, CentOS 8+, RHEL 8+
- **RAM** : 4 GB minimum (8 GB recommand√©)
- **CPU** : 2 cores minimum (4 cores recommand√©)
- **Stockage** : 500 GB minimum pour les backups
- **R√©seau** : Connexion stable, ports 22 et 3000 ouverts

### Stockage Recommand√©
- **SSD** pour le syst√®me et la base de donn√©es
- **HDD** en RAID 1/5/6 pour le stockage des backups
- **Partition s√©par√©e** pour `/backups` (recommand√©)

## üöÄ Installation Pas √† Pas

### 1. Mise √† Jour du Syst√®me

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git unzip htop fail2ban ufw

# CentOS/RHEL
sudo dnf update -y
sudo dnf install -y curl wget git unzip htop fail2ban firewalld
```

### 2. Installation de Node.js

```bash
# M√©thode recommand√©e via NodeSource
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# V√©rifier l'installation
node --version
npm --version

# Alternative avec snap (Ubuntu)
sudo snap install node --classic
```

### 3. Cr√©ation de l'Utilisateur EFC Backup

```bash
# Cr√©er un utilisateur d√©di√©
sudo adduser efc-backup

# Ajouter aux groupes n√©cessaires
sudo usermod -aG sudo efc-backup
sudo usermod -aG backup efc-backup

# Passer √† l'utilisateur
sudo su - efc-backup
```

### 4. Configuration des Dossiers

```bash
# Cr√©er la structure des dossiers
sudo mkdir -p /opt/efc-backup
sudo mkdir -p /var/backups/efc
sudo mkdir -p /var/log/efc-backup
sudo mkdir -p /etc/efc-backup

# D√©finir les permissions
sudo chown -R efc-backup:efc-backup /opt/efc-backup
sudo chown -R efc-backup:efc-backup /var/backups/efc
sudo chown -R efc-backup:efc-backup /var/log/efc-backup
sudo chown -R efc-backup:efc-backup /etc/efc-backup

# Permissions de s√©curit√©
sudo chmod 755 /opt/efc-backup
sudo chmod 750 /var/backups/efc
sudo chmod 750 /var/log/efc-backup
sudo chmod 700 /etc/efc-backup
```

### 5. Installation du Syst√®me EFC Backup

```bash
# Aller dans le dossier d'installation
cd /opt/efc-backup

# T√©l√©charger le syst√®me (ou copier depuis votre d√©veloppement)
# Option 1: Git clone
git clone https://github.com/votre-repo/efc-backup.git .

# Option 2: Copie directe
scp -r /root/efc-backup/* efc-backup@serveur-ip:/opt/efc-backup/

# Installer les d√©pendances
npm install --production
```

### 6. Configuration de l'Environnement

```bash
# Copier le fichier de configuration
cp .env.example .env

# √âditer la configuration
nano .env
```

Configuration recommand√©e pour serveur Linux :

```env
# Configuration Serveur Linux Production
PORT=3000
NODE_ENV=production
HOST=0.0.0.0

# Chemins Linux
BACKUP_PATH=/var/backups/efc
LOG_PATH=/var/log/efc-backup
TEMP_PATH=/tmp/efc-backup

# Configuration des Backups
RETENTION_DAYS=90
MAX_PARALLEL_BACKUPS=3
COMPRESSION_ENABLED=true
COMPRESSION_LEVEL=6
USE_VSS=true

# Planning par D√©faut
DAILY_BACKUP_TIME=02:00
WEEKLY_BACKUP_DAY=0
WEEKLY_BACKUP_TIME=03:00
MONTHLY_BACKUP_DAY=1
MONTHLY_BACKUP_TIME=04:00

# Base de Donn√©es
DB_TYPE=sqlite
DB_PATH=/var/lib/efc-backup/database.db

# S√©curit√©
JWT_SECRET=$(openssl rand -base64 32)
ADMIN_PASSWORD=VotreMotDePasseSecurise123!
SESSION_TIMEOUT=3600000

# Performance
MAX_FILE_SIZE=53687091200
CHUNK_SIZE=134217728
TRANSFER_SPEED_LIMIT=0
CACHE_ENABLED=true

# Monitoring
ENABLE_METRICS=true
HEALTH_CHECK_INTERVAL=60000
ALERT_DISK_USAGE_PERCENT=85
ALERT_BACKUP_AGE_HOURS=48

# Logs
LOG_LEVEL=info
LOG_MAX_SIZE=52428800
LOG_MAX_FILES=30
LOG_COMPRESS=true
```

### 7. Installation de PM2 (Gestionnaire de Process)

```bash
# Installer PM2 globalement
sudo npm install -g pm2

# Configurer PM2 pour l'utilisateur
pm2 startup
# Suivre les instructions affich√©es

# Cr√©er un fichier de configuration PM2
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'efc-backup',
    script: './src/index.js',
    cwd: '/opt/efc-backup',
    instances: 1,
    exec_mode: 'fork',
    watch: false,
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: '/var/log/efc-backup/pm2.log',
    out_file: '/var/log/efc-backup/pm2-out.log',
    error_file: '/var/log/efc-backup/pm2-error.log',
    time: true,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s',
    max_memory_restart: '1G'
  }]
}
EOF
```

## üî• Configuration du Pare-feu

### UFW (Ubuntu/Debian)

```bash
# Activer UFW
sudo ufw enable

# Autoriser SSH
sudo ufw allow 22/tcp

# Autoriser EFC Backup
sudo ufw allow 3000/tcp

# Autoriser depuis des IPs sp√©cifiques (recommand√©)
sudo ufw allow from 192.168.1.0/24 to any port 3000
sudo ufw allow from IP_DE_VOS_CLIENTS to any port 3000

# V√©rifier les r√®gles
sudo ufw status
```

### Firewalld (CentOS/RHEL)

```bash
# D√©marrer firewalld
sudo systemctl start firewalld
sudo systemctl enable firewalld

# Autoriser les ports
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=3000/tcp

# Autoriser depuis des sources sp√©cifiques
sudo firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.1.0/24' port protocol='tcp' port='3000' accept"

# Recharger la configuration
sudo firewall-cmd --reload
```

## üîê S√©curisation du Serveur

### 1. Configuration SSH S√©curis√©e

```bash
# √âditer la configuration SSH
sudo nano /etc/ssh/sshd_config

# Modifications recommand√©es :
# Port 2222                    # Changer le port par d√©faut
# PermitRootLogin no          # Interdire root
# PasswordAuthentication no    # Utiliser uniquement les cl√©s
# AllowUsers efc-backup       # Autoriser seulement l'utilisateur EFC
```

### 2. Authentification par Cl√©s SSH

```bash
# G√©n√©rer une paire de cl√©s (sur votre poste admin)
ssh-keygen -t rsa -b 4096 -C "admin@efc-backup"

# Copier la cl√© publique sur le serveur
ssh-copy-id efc-backup@IP_SERVEUR

# Tester la connexion
ssh efc-backup@IP_SERVEUR
```

### 3. Configuration Fail2Ban

```bash
# Cr√©er une configuration pour EFC Backup
sudo nano /etc/fail2ban/jail.local

[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3

[efc-backup]
enabled = true
port = 3000
filter = efc-backup
logpath = /var/log/efc-backup/app.log
maxretry = 5
bantime = 1800

# Cr√©er le filtre
sudo nano /etc/fail2ban/filter.d/efc-backup.conf

[Definition]
failregex = .*Failed login attempt from <HOST>.*
            .*Authentication failed.*<HOST>.*
            .*Invalid credentials.*<HOST>.*

# Red√©marrer Fail2Ban
sudo systemctl restart fail2ban
```

## üéØ D√©marrage du Service

### 1. Test Initial

```bash
# Test de base
cd /opt/efc-backup
npm start

# V√©rifier que l'interface est accessible
curl http://localhost:3000
```

### 2. D√©marrage avec PM2

```bash
# D√©marrer avec PM2
pm2 start ecosystem.config.js

# V√©rifier le status
pm2 status
pm2 logs efc-backup

# Sauvegarder la configuration
pm2 save
```

### 3. Service Syst√®me (Alternative)

```bash
# Cr√©er un service systemd
sudo nano /etc/systemd/system/efc-backup.service

[Unit]
Description=EFC Backup System
After=network.target
Wants=network.target

[Service]
Type=simple
User=efc-backup
Group=efc-backup
WorkingDirectory=/opt/efc-backup
ExecStart=/usr/bin/node /opt/efc-backup/src/index.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=efc-backup
Environment=NODE_ENV=production
Environment=PATH=/usr/bin:/usr/local/bin
KillMode=mixed
TimeoutStopSec=20

[Install]
WantedBy=multi-user.target

# Activer le service
sudo systemctl daemon-reload
sudo systemctl enable efc-backup
sudo systemctl start efc-backup
sudo systemctl status efc-backup
```

## üìä Configuration du Stockage

### 1. Disque D√©di√© aux Backups

```bash
# Identifier le disque
sudo fdisk -l

# Cr√©er une partition
sudo fdisk /dev/sdb
# n -> p -> 1 -> entr√©e -> entr√©e -> w

# Formater en ext4
sudo mkfs.ext4 /dev/sdb1

# Cr√©er le point de montage
sudo mkdir -p /mnt/efc-backups

# Monter temporairement
sudo mount /dev/sdb1 /mnt/efc-backups

# Obtenir l'UUID
sudo blkid /dev/sdb1

# Ajouter au fstab pour montage automatique
echo "UUID=votre-uuid-ici /var/backups/efc ext4 defaults,noatime 0 2" | sudo tee -a /etc/fstab

# Tester le montage
sudo mount -a
```

### 2. RAID (Recommand√© pour Production)

```bash
# Installer mdadm
sudo apt install mdadm

# Cr√©er un RAID 1 avec 2 disques
sudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sdb /dev/sdc

# Formater et monter
sudo mkfs.ext4 /dev/md0
sudo mount /dev/md0 /var/backups/efc

# Ajouter au fstab
echo "/dev/md0 /var/backups/efc ext4 defaults,noatime 0 2" | sudo tee -a /etc/fstab
```

## üîß Configuration Avanc√©e

### 1. Optimisation R√©seau

```bash
# Optimiser pour les transferts SSH
echo "net.core.rmem_max = 134217728" | sudo tee -a /etc/sysctl.conf
echo "net.core.wmem_max = 134217728" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_rmem = 4096 65536 134217728" | sudo tee -a /etc/sysctl.conf
echo "net.ipv4.tcp_wmem = 4096 65536 134217728" | sudo tee -a /etc/sysctl.conf

# Appliquer les changements
sudo sysctl -p
```

### 2. Rotation des Logs

```bash
# Cr√©er une configuration logrotate
sudo nano /etc/logrotate.d/efc-backup

/var/log/efc-backup/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 efc-backup efc-backup
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 3. Monitoring avec Cron

```bash
# Ajouter des t√¢ches cron
crontab -e

# V√©rification quotidienne de l'espace disque
0 8 * * * /opt/efc-backup/scripts/check-disk-space.sh

# Nettoyage hebdomadaire
0 2 * * 0 /opt/efc-backup/scripts/cleanup-old-backups.sh

# Health check toutes les 5 minutes
*/5 * * * * /opt/efc-backup/scripts/health-check.sh
```

### 4. Sauvegarde de la Configuration

```bash
# Script de sauvegarde quotidienne de la DB
cat > /opt/efc-backup/scripts/backup-config.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d)
cp /var/lib/efc-backup/database.db /var/backups/efc/config-backup-$DATE.db
find /var/backups/efc -name "config-backup-*.db" -mtime +7 -delete
EOF

chmod +x /opt/efc-backup/scripts/backup-config.sh

# Ajouter au cron
0 1 * * * /opt/efc-backup/scripts/backup-config.sh
```

## üìù Configuration HTTPS (Recommand√©)

### Avec Nginx Reverse Proxy

```bash
# Installer Nginx
sudo apt install nginx

# Configuration Nginx
sudo nano /etc/nginx/sites-available/efc-backup

server {
    listen 80;
    server_name backup.efcinfo.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name backup.efcinfo.com;

    ssl_certificate /etc/ssl/certs/efc-backup.crt;
    ssl_certificate_key /etc/ssl/private/efc-backup.key;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Activer le site
sudo ln -s /etc/nginx/sites-available/efc-backup /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## ‚úÖ V√©rification Finale

### Tests de Fonctionnement

```bash
# V√©rifier les services
sudo systemctl status efc-backup
pm2 status

# V√©rifier les ports
sudo netstat -tlnp | grep -E "(3000|443|80)"

# Test de l'interface web
curl http://localhost:3000
curl -k https://backup.efcinfo.com

# V√©rifier les logs
tail -f /var/log/efc-backup/app.log

# Test de connexion SSH depuis un client Windows
ssh backupuser@IP_CLIENT
```

### Checklist de S√©curit√©

- ‚úÖ Firewall configur√© avec r√®gles strictes
- ‚úÖ SSH s√©curis√© (port chang√©, cl√©s uniquement)
- ‚úÖ Fail2Ban actif
- ‚úÖ Utilisateur d√©di√© sans privil√®ges root
- ‚úÖ HTTPS configur√© (si applicable)
- ‚úÖ Logs rotationn√©s automatiquement
- ‚úÖ Surveillance de l'espace disque

## üÜò Commandes de Maintenance

```bash
# Red√©marrer EFC Backup
pm2 restart efc-backup

# Voir les logs en temps r√©el
pm2 logs efc-backup --lines 100

# V√©rifier l'espace disque
df -h /var/backups/efc

# Status complet du syst√®me
sudo systemctl status efc-backup
sudo systemctl status nginx
sudo systemctl status fail2ban

# Nettoyer les anciens backups manuellement
find /var/backups/efc -type f -mtime +90 -delete

# Backup de la configuration
sudo tar -czf /tmp/efc-config-$(date +%Y%m%d).tar.gz /opt/efc-backup/.env /var/lib/efc-backup/
```

---

**üéâ Serveur Linux Configur√© !**

Votre serveur Linux est maintenant pr√™t √† recevoir et g√©rer les backups de vos clients Windows. L'interface web EFC Backup est accessible et s√©curis√©e.