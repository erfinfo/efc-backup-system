# üì¶ EFC Backup System - Documentation Compl√®te

Syst√®me professionnel de backup automatique pour clients Windows avec interface web standalone.

## üöÄ Installation Rapide

### Pr√©requis Syst√®me

#### Sur le serveur de backup (Linux/Windows/Mac)
- **Node.js** version 16 ou sup√©rieure
- **npm** version 7 ou sup√©rieure
- **Espace disque** : Au moins 100 GB pour stocker les backups
- **RAM** : Minimum 2 GB recommand√©
- **Ports** : Port 3000 (configurable) pour l'interface web

#### Sur les clients Windows √† sauvegarder
- **Windows 10/11** ou **Windows Server 2016+**
- **OpenSSH Server** activ√© (voir configuration ci-dessous)
- **Compte administrateur** pour les backups syst√®me
- **PowerShell 5.0+** install√©

## üìã Installation √âtape par √âtape

### 1. Installation de Node.js

#### Linux (Ubuntu/Debian)
```bash
# Mettre √† jour le syst√®me
sudo apt update && sudo apt upgrade -y

# Installer Node.js via NodeSource
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# V√©rifier l'installation
node --version
npm --version
```

#### Windows
1. T√©l√©charger Node.js depuis https://nodejs.org/
2. Ex√©cuter l'installateur MSI
3. Red√©marrer le terminal
4. V√©rifier avec `node --version`

#### macOS
```bash
# Avec Homebrew
brew install node

# Ou t√©l√©charger depuis nodejs.org
```

### 2. Installation du Syst√®me EFC Backup

```bash
# Cloner le projet depuis GitHub
cd /opt  # ou C:\ sur Windows
git clone https://github.com/erfinfo/efc-backup-system.git efc-backup

# Acc√©der au dossier
cd efc-backup

# Installer les d√©pendances
npm install

# Cr√©er le fichier de configuration
cp .env.example .env  # ou copy sur Windows
```

### 3. Configuration Initiale

Cr√©er un fichier `.env` √† la racine du projet :

```env
# Configuration du serveur
PORT=3000
NODE_ENV=production

# Chemins de stockage
BACKUP_PATH=/var/backups/efc
LOG_PATH=/var/log/efc-backup

# Configuration des backups
RETENTION_DAYS=30
MAX_PARALLEL_BACKUPS=2
COMPRESSION_ENABLED=true

# Notifications
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
NOTIFICATION_EMAIL=admin@company.com

# S√©curit√©
JWT_SECRET=change-this-secret-key-in-production
ADMIN_PASSWORD=changeme123

# Base de donn√©es
DB_PATH=./data/efc-backup.db
```

### 4. Cr√©ation des dossiers n√©cessaires

```bash
# Linux/Mac
sudo mkdir -p /var/backups/efc
sudo mkdir -p /var/log/efc-backup
sudo chown -R $USER:$USER /var/backups/efc /var/log/efc-backup

# Windows (PowerShell en admin)
New-Item -ItemType Directory -Path "C:\Backups\EFC" -Force
New-Item -ItemType Directory -Path "C:\Logs\EFC-Backup" -Force
```

## üñ•Ô∏è Configuration des Clients Windows

### Activer OpenSSH Server sur Windows

#### Windows 10/11
```powershell
# Ex√©cuter PowerShell en tant qu'administrateur

# Installer OpenSSH Server
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

# D√©marrer le service
Start-Service sshd

# Configurer le d√©marrage automatique
Set-Service -Name sshd -StartupType 'Automatic'

# V√©rifier le pare-feu
New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
```

#### Windows Server
```powershell
# Installer la fonctionnalit√©
Install-WindowsFeature -Name OpenSSH.Server

# D√©marrer et configurer
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'
```

### Cr√©er un utilisateur de backup

```powershell
# Cr√©er un utilisateur d√©di√© aux backups
$Password = ConvertTo-SecureString "BackupP@ssw0rd!" -AsPlainText -Force
New-LocalUser -Name "backupuser" -Password $Password -FullName "EFC Backup User" -Description "Compte pour les backups automatiques"

# Ajouter aux groupes n√©cessaires
Add-LocalGroupMember -Group "Administrators" -Member "backupuser"
Add-LocalGroupMember -Group "Backup Operators" -Member "backupuser"
```

### Configurer les permissions VSS

```powershell
# Donner les droits VSS √† l'utilisateur backup
vssadmin add shadowstorage /for=C: /on=C: /maxsize=10GB
```

## üöÄ D√©marrage du Syst√®me

### Mode Production

```bash
# D√©marrer le serveur
npm start

# Ou avec PM2 pour la production (recommand√©)
npm install -g pm2
pm2 start src/index.js --name efc-backup
pm2 save
pm2 startup
# Suivre les instructions affich√©es pour configurer le d√©marrage automatique
```

### Configuration PM2 pour le D√©marrage Automatique

Pour que le serveur EFC Backup d√©marre automatiquement au boot du syst√®me :

```bash
# Installer PM2 globalement
npm install -g pm2

# D√©marrer le service EFC Backup avec PM2
pm2 start src/index.js --name efc-backup

# Sauvegarder la configuration PM2
pm2 save

# Configurer le d√©marrage automatique
pm2 startup

# Ex√©cuter la commande affich√©e par pm2 startup (exemple) :
# sudo env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u root --hp /root

# V√©rifier le statut
pm2 status
```

**Commandes PM2 utiles :**
- `pm2 status` - Voir le statut des processus
- `pm2 logs efc-backup` - Voir les logs en temps r√©el  
- `pm2 restart efc-backup` - Red√©marrer le service
- `pm2 stop efc-backup` - Arr√™ter le service
- `pm2 delete efc-backup` - Supprimer le service
- `pm2 monit` - Interface de monitoring

### Mode D√©veloppement

```bash
# Avec rechargement automatique
npm run dev
```

### Service Syst√®me (Linux)

Cr√©er `/etc/systemd/system/efc-backup.service` :

```ini
[Unit]
Description=EFC Backup System
After=network.target

[Service]
Type=simple
User=efc-backup
WorkingDirectory=/opt/efc-backup
ExecStart=/usr/bin/node /opt/efc-backup/src/index.js
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=efc-backup
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

Activer le service :
```bash
sudo systemctl daemon-reload
sudo systemctl enable efc-backup
sudo systemctl start efc-backup
sudo systemctl status efc-backup
```

## üåê Utilisation de l'Interface Web

### Acc√®s Initial

1. Ouvrir un navigateur web
2. Acc√©der √† `http://IP_DU_SERVEUR:3000`
3. Se connecter avec le mot de passe d√©fini dans `.env`

### Dashboard Principal

Le dashboard affiche :
- **Clients Actifs** : Nombre de clients configur√©s
- **Backups Aujourd'hui** : Backups effectu√©s dans les 24h
- **Espace Utilis√©** : Espace disque total des backups
- **Derni√®re Ex√©cution** : Heure du dernier backup

### Ajouter un Client

1. Cliquer sur l'onglet **"Clients"**
2. Cliquer sur **"Ajouter Client"**
3. Remplir les informations :
   - **Nom** : Identifiant unique du client
   - **Adresse IP** : IP ou nom d'h√¥te du client Windows
   - **Port SSH** : 22 par d√©faut
   - **Utilisateur** : backupuser (cr√©√© pr√©c√©demment)
   - **Mot de passe** : Mot de passe du compte
   - **Type de backup** : 
     - Complet : Backup total
     - Incr√©mentiel : Seulement les changements
     - Diff√©rentiel : Changements depuis le dernier complet
   - **Dossiers** : Chemins √† sauvegarder (ex: `C:\Users, C:\Program Files`)

### Planification des Backups

1. Aller dans **"Planification"**
2. Configurer les horaires :
   - **Quotidien** : Backup incr√©mentiel tous les jours
   - **Hebdomadaire** : Backup complet le dimanche
   - **Mensuel** : Archive compl√®te le 1er du mois

### Types de Backup

#### Backup Manuel
- Cliquer sur **"Backup Manuel"** dans le dashboard
- S√©lectionner les clients
- Choisir le type de backup
- Lancer l'op√©ration

#### Backup Automatique
Les backups se lancent automatiquement selon la planification configur√©e.

## üìä Monitoring et Logs

### Visualisation des Logs

1. Onglet **"Logs"** dans l'interface
2. Filtrer par niveau :
   - **Info** : Op√©rations normales
   - **Warning** : Avertissements
   - **Error** : Erreurs critiques

### Fichiers de Logs

Les logs sont stock√©s dans :
- Linux : `/var/log/efc-backup/`
- Windows : `C:\Logs\EFC-Backup\`

Format des fichiers :
- `app-YYYY-MM-DD.log` : Logs de l'application
- `backup-YYYY-MM-DD.log` : Logs des backups
- `error-YYYY-MM-DD.log` : Erreurs uniquement

## üîß Maintenance

### Rotation des Backups

Le syst√®me supprime automatiquement les backups de plus de X jours (configur√© dans `RETENTION_DAYS`).

Pour une rotation manuelle :
```bash
# Linux
find /var/backups/efc -type f -mtime +30 -delete

# Windows PowerShell
Get-ChildItem "C:\Backups\EFC" -Recurse | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item
```

### Sauvegarde de la Base de Donn√©es

```bash
# Sauvegarder la configuration
cp data/efc-backup.db data/efc-backup.db.backup

# Exporter en JSON
sqlite3 data/efc-backup.db .dump > backup-config.sql
```

### Mise √† Jour du Syst√®me

```bash
# Arr√™ter le service
pm2 stop efc-backup

# Sauvegarder la configuration
cp -r config config.backup
cp .env .env.backup

# Mettre √† jour depuis GitHub
git pull origin master
npm install

# Red√©marrer
pm2 restart efc-backup
```

## üö® D√©pannage

### Le client Windows n'est pas accessible

1. V√©rifier que SSH est actif :
```powershell
Get-Service sshd
```

2. Tester la connexion :
```bash
ssh backupuser@IP_CLIENT
```

3. V√©rifier le pare-feu Windows :
```powershell
Get-NetFirewallRule -Name sshd
```

### Erreur "VSS not available"

Ex√©cuter sur le client Windows :
```powershell
# R√©parer VSS
vssadmin list writers
vssadmin list shadows
vssadmin delete shadows /all

# Red√©marrer le service
Restart-Service VSS
```

### L'interface web ne se charge pas

1. V√©rifier que le serveur est lanc√© :
```bash
pm2 status
# ou
systemctl status efc-backup
```

2. V√©rifier les logs :
```bash
pm2 logs efc-backup
# ou
journalctl -u efc-backup -f
```

3. V√©rifier le port :
```bash
netstat -tulpn | grep 3000
```

### Espace disque insuffisant

1. V√©rifier l'espace :
```bash
df -h /var/backups/efc
```

2. Nettoyer les anciens backups :
```bash
npm run cleanup
```

## üìû Support

### Logs de Debug

Pour activer les logs d√©taill√©s :
```bash
NODE_ENV=development npm start
```

### Structure des Backups

Les backups sont organis√©s ainsi :
```
/var/backups/efc/
‚îú‚îÄ‚îÄ backup_CLIENT1_1234567890/
‚îÇ   ‚îú‚îÄ‚îÄ backup_metadata.json
‚îÇ   ‚îú‚îÄ‚îÄ system_info.json
‚îÇ   ‚îú‚îÄ‚îÄ Users/
‚îÇ   ‚îú‚îÄ‚îÄ ProgramData/
‚îÇ   ‚îî‚îÄ‚îÄ registry/
‚îÇ       ‚îú‚îÄ‚îÄ SOFTWARE.reg
‚îÇ       ‚îú‚îÄ‚îÄ SYSTEM.reg
‚îÇ       ‚îî‚îÄ‚îÄ CURRENT_USER_SOFTWARE.reg
‚îî‚îÄ‚îÄ backup_CLIENT2_1234567891/
    ‚îî‚îÄ‚îÄ ...
```

### Restauration d'un Backup

1. Localiser le backup dans `/var/backups/efc/`
2. Copier les fichiers vers le client via SCP
3. Restaurer le registre si n√©cessaire :
```powershell
reg import "C:\Restore\SOFTWARE.reg"
```

## üîí S√©curit√©

### Recommandations

1. **Changer les mots de passe par d√©faut** dans `.env`
2. **Utiliser HTTPS** avec un certificat SSL
3. **Limiter l'acc√®s** √† l'interface par IP
4. **Chiffrer les backups** sensibles
5. **Auditer r√©guli√®rement** les acc√®s

### Configuration HTTPS

```javascript
// Dans src/index.js, ajouter :
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('private-key.pem'),
  cert: fs.readFileSync('certificate.pem')
};

https.createServer(options, app).listen(443);
```

## üìà Performances

### Optimisation

- **Compression** : Activ√©e par d√©faut pour r√©duire l'espace
- **Parall√©lisation** : 2 backups simultan√©s maximum
- **Bande passante** : Limitation possible dans la configuration

### Monitoring des Ressources

```bash
# CPU et RAM
top -p $(pgrep -f efc-backup)

# Espace disque
watch -n 60 'df -h /var/backups/efc'

# R√©seau
iftop -i eth0
```

## üìù Notes Importantes

1. **Tester les backups** r√©guli√®rement en restaurant sur une machine de test
2. **Conserver une copie** des backups hors site
3. **Documenter** la configuration de chaque client
4. **Former** les utilisateurs sur la proc√©dure de restauration
5. **Planifier** les backups en dehors des heures de production

---

**Version** : 1.0.1  
**Derni√®re mise √† jour** : 2024  
**Support** : erick@efcinfo.com  
**Repository GitHub** : https://github.com/erfinfo/efc-backup-system  
**Site web** : https://efcinfo.com